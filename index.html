<!DOCTYPE html>
<html>
<head>
<style>
body {
    font-family: Arial, sans-serif;
background-image: url("Player.png");
    background-repeat: no-repeat;
    background-size: cover;
}

body.dark-mode {
    background-image: url("Player Darkmode.png");
}

</style>
</head>
<body>


</body>
</html>

<button id="toggleShortcuts" style="position: fixed; top: 130px; left: 10px; padding: 10px;  background-color: lightgrey; border-radius: 15px; border: none; cursor: pointer;" onclick="toggleShortcuts()">&#8963;</button>

<div id="shortcuts" style="position: fixed; top: 150px; left: 10px; padding: 10px;  background-color: lightgrey; border-radius: 15px; display: none;">
    <h3>Nützliche Shortcuts</h3>
    <table>
        <tr><td><b>Leertaste</b></td><td>: Play/Pause</td></tr>
        <tr><td><b>M</b></td><td>: Marker setzen</td></tr>
        <tr><td><b>Alt + S</b></td><td>: Stand speichern</td></tr>
        <tr><td><b>Pfeil links</b></td><td>: 5sek zurück</td></tr>
        <tr><td><b>Pfeil rechts</b></td><td>: 5sek vor</td></tr>
        <tr><td><b>Alt + Pfeil links</b></td><td>: 1 Frame zurück</td></tr>
        <tr><td><b>Alt + Pfeil rechts</b></td><td>: 1 Frame vor</td></tr>
    </table>
</div>

<div style="position: fixed; top: 10px; left: 10px;">
    <button onclick="toggleDarkMode()" 
                        style="display: block; background-color: gray; 
                        color: white; padding: 10px; border-radius: 15px; cursor: pointer; margin-bottom: 10px;"> 
                         Dark Mode umschalten 
       </button>
        <select onchange="changeVideoSize(this.value)" style="padding: 10px; border-radius: 15px; cursor: pointer;">
            <option value="">Größe ändern</option>
            <option value="480">Klein</option>
            <option value="720">Mittel</option>
            <option value="1280">Groß</option>
        </select>
    </div>
    
    <div style="display: flex; justify-content: center; gap: 10px;">
        <input type="file" id="videoFile" accept=".mp4,.mov" onchange="loadVideo(event)" 
               style="display: inline-block; background-color: red; color: white; padding: 10px; border-radius: 15px; 
                      cursor: pointer; margin-right: 10px;">
        <select onchange="handleSaveOptions(this)" style="padding: 10px; padding-left: 50px; border-radius: 15px; cursor: pointer;">
    	<option selected disabled>Speichern/Laden</option>
    	<option value="save">Stand speichern</option>
   	<option value="load">Speicherstand laden</option>
   	</select>
	<input type="file" id="loadMarkersFile" style="display: none;" onchange="loadMarkers(event)">

<div style="position: absolute; left: 83.75%; top: 50px; width: 16%;">
    <h2 class="transcript-related">Interaktives Transkript</h2>
    <input class="transcript-related" type="file" id="transcriptFile" accept=".json,.txt" onchange="loadTranscript(event)"
        style="display: inline-block; background-color: red; color: white; padding: 10px; border-radius: 15px; cursor: pointer; margin-bottom: 10px;">
    <input class="transcript-related" type="search" id="transcriptSearch" placeholder="Suchen im Transkript..."
        style="display: inline-block; padding: 10px; border-radius: 15px; cursor: pointer; margin-bottom: 10px; width: 100%;">
    <div class="transcript-related" id="transcript" style="border: solid 1px #ccc; padding: 10px; height: 720px; overflow-y: scroll;"></div>
</div>

<select onchange="handleExportOptions(this)" 
                style="display: inline-block; background-color: green; color: white; padding: 10px; border-radius: 15px; cursor: pointer;">
            <option selected disabled>Anmerkungen Exportieren</option>
            <option value="markers">Für AVID exportieren</option>
            <option value="table"> Als Tabelle exportieren</option>
        </select>

</div>    
<button style="position: absolute; top: 1.3%; right: 9.5%; padding: 10px; border-radius: 15px; cursor: pointer;" onclick="toggleTranscript()">Transkript ein/aus</button>
</div>
</div>
        


<div style="text-align: center; margin-top: 10px;">
    <video id="myVideo" width="1280" height="720" controls style="display:block; margin: 0 auto; border-radius: 15px;"></video>
</div>

<div style="text-align: center; margin-top: 10px;">
    <button onclick="rewind(5)" style="padding: 10px; border-radius: 15px; cursor: pointer;">&#8647 5sek</button>
<button onclick="rewind(1/25)" style="padding: 10px; border-radius: 15px; cursor: pointer;">&#8592 Frame</button>
<button onclick="setMarker()" style="background-color: orange; padding: 10px; border-radius: 15px; cursor: pointer;">Anmerkung setzen</button>
<button onclick="forward(1/25)" style="padding: 10px; border-radius: 15px; cursor: pointer;">Frame &#8594</button>
<button onclick="forward(5)" style="padding: 10px; border-radius: 15px; cursor: pointer;">5sek &#8649</button>
</div>

<ul id="markerList" style="padding: 20px; height: 300px; overflow: auto;"></ul>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
var markers = [];
var videoFile = '';
var videoElement;

function loadVideo(event) {
    var file = event.target.files[0];
    videoFile = file.name;
    var url = URL.createObjectURL(file);

    videoElement = document.getElementById("myVideo"); 
    videoElement.src = url;
    videoElement.load();
    markers = [];
    updateMarkerList();

videoElement.addEventListener('timeupdate', (event) => {
    let currentTime = event.target.currentTime;
    var body = document.body;
    var isDarkMode = body.classList.contains('dark-mode');
    document.querySelectorAll('#transcript p').forEach(p => {
        let pTime = parseFloat(p.getAttribute('data-time'));
        var underlineDuration = 1.0; // Dauer in Sekunden
        if(Math.abs(currentTime - pTime) <= underlineDuration) { 
p.style.textDecoration = isDarkMode ? 'underline white' : 'underline';
p.style.textDecorationThickness = '4px'; // Ändern Sie diesen Wert, um die Dicke des Unterstrichs zu ändern
p.style.textDecorationColor = 'orange'; // Ändern Sie diesen Wert, um die Farbe des Unterstrichs zu ändern 
p.scrollIntoView({behavior: 'smooth', block: 'nearest'});
        } else {
p.style.textDecoration = 'none';
	if (p.style.color !== 'green')
                p.style.color = isDarkMode ? 'white' : 'black'; // If Dark Mode is on, set color to white. Else, set color to black.
	}
    });
});
}

function toggleTranscript() {
    // Selektiert alle Elemente mit der Klasse 'transcript-related'
    var transcriptRelatedElements = document.getElementsByClassName('transcript-related');

    // Iteriert durch alle Elemente und toggled die Sichtbarkeit
    for (var i = 0; i < transcriptRelatedElements.length; i++) {
        if (transcriptRelatedElements[i].style.display === "none") {
            transcriptRelatedElements[i].style.display = "block";
        } else {
            transcriptRelatedElements[i].style.display = "none";
        }
    }
}

function loadTranscript(event) {
    var file = event.target.files[0];
    var reader = new FileReader();
    reader.onload = function(e) {
        var sections = e.target.result.split('\n\n'); // Teilt die Datei in Elemente, getrennt durch leere Zeilen
        const transcriptDiv = document.getElementById('transcript');
        transcriptDiv.innerHTML = ''; // Leert das Transkript-Feld
        sections.forEach(section => {
            var lines = section.split('\n'); // Teilt den Abschnitt in Zeilen
            if (lines.length < 2) return; // Ignoriert Abschnitte, die weniger als 2 Zeilen haben
            var timestamps = lines[0]; // Der Zeitstempel ist die erste Zeile
            var text = lines.slice(1).join(' '); // Der Rest der Zeilen ist der Transkripttext
            const p = document.createElement('p');
            
            // Überprüft, ob der Text einen Sprecher enthält und entfernt ihn
            var speakerIndex = text.indexOf(':');
            if (speakerIndex !== -1) {
                text = text.slice(speakerIndex + 1).trim(); // Entfernt den Sprecher vom Anfang des Textes
                if (lines[1].startsWith('Sprechertext:')) {
                    p.style.color = 'green'; // Setzt die Textfarbe auf grün, wenn der Sprecher "Sprechertext" ist
 		p.style.fontWeight = 'bold'; // Setzt den Text auf fett, wenn der Sprecher "Sprechertext" ist
                }
            }
            
            p.textContent = text;
            p.style.cursor = 'pointer';
            // Umwandelt den Startzeitstempel in Sekunden
            var startTime = timestamps.split(' ')[0];
            var timeParts = startTime.split(':');
            var time = 
                Number(timeParts[0]) * 3600 +  // Stunden
                Number(timeParts[1]) * 60 +    // Minuten
                Number(timeParts[2]) +         // Sekunden
                Number(timeParts[3]) / 25;     // Frames (angenommen, es gibt 25 Frames pro Sekunde)

            p.setAttribute('data-time', time);
        
            p.onclick = () => {
                videoElement.currentTime = time;
            }
            transcriptDiv.appendChild(p);
        });
    }
    reader.readAsText(file);
}

document.getElementById('transcriptSearch').addEventListener('input', function (e) {
  var searchString = e.target.value.toLowerCase();
  var transcriptLines = document.querySelectorAll('#transcript p');
  transcriptLines.forEach(function (line) {
    var lineText = line.textContent.toLowerCase();
    if (lineText.includes(searchString)) {
      line.style.display = 'block';
    } else {
      line.style.display = 'none';
    }
  });

  // Wenn das Suchfeld geleert wird, scrollt das Transkript-Fenster zur aktuellen Position im Video
  if (searchString === '') {
    var currentTime = videoElement.currentTime;
    transcriptLines.forEach(function (line) {
      var lineTime = parseFloat(line.getAttribute('data-time'));
      if (Math.abs(currentTime - lineTime) <= 0.5) {
        line.scrollIntoView({behavior: 'smooth'});
      }
    });
 // Entfernt den Fokus vom Suchfeld
    e.target.blur();
  }
});



function toggleShortcuts() {
  var button = document.getElementById('toggleShortcuts');
  var shortcutsDiv = document.getElementById('shortcuts');
  if (shortcutsDiv.style.display === "none") {
      shortcutsDiv.style.display = "block";
      button.innerHTML = "&#8963;"; // Pfeil-nach-oben Symbol
  } else {
      shortcutsDiv.style.display = "none";
      button.innerHTML = "&#8964;"; // Pfeil-nach-unten Symbol
  }
}

function toggleDarkMode() {
    var body = document.body;
    if (body.classList.contains('dark-mode')) {
        body.classList.remove('dark-mode');
    } else {
        body.classList.add('dark-mode');
    }
}

function changeVideoSize(size) {
    var videoElement = document.getElementById('myVideo');
    videoElement.style.width = size + 'px';
    videoElement.style.height = 'auto';
}

function setMarker() {
    var currentTime = videoElement.currentTime;
    var description = prompt("Bitte geben Sie eine Anmerkung für den Marker ein");
    var timecode = convertTimeToTimecode(currentTime, 25);
    markers.push({timeInSeconds: currentTime, timecode: timecode, description: description});
    updateMarkerList();
}

function updateMarkerList() {
    var markerList = $('#markerList');
    markerList.empty();
    markers.forEach(function(marker, index) {
        var listItem = $('<li></li>');
        var jumpButton = $('<button style="margin-right: 10px;">Gehe zu</button>');
        jumpButton.click(function(){
            videoElement.currentTime = marker.timeInSeconds;
        });
        listItem.text('Timecode: ' + marker.timecode + ', Anmerkung: ' + marker.description);
        listItem.prepend(jumpButton);
        var actionSelect = $('<select class="actionSelect" onchange="handleMarkerActions(this, ' + index + ')" style="margin-left:10px; padding: 10px; border-radius: 15px; cursor: pointer;"><option selected disabled>Aktionen</option><option value="edit">Anmerkung ändern</option><option value="delete">Löschen</option></select>');
        listItem.append(actionSelect);
        markerList.append(listItem);
    });
}

function handleMarkerActions(selectElem, index) {
    var selectedOption = selectElem.value;
    if (selectedOption === 'edit') {
        var newDescription = prompt("Bitte geben Sie eine neue Anmerkung ein");
        markers[index].description = newDescription;
        updateMarkerList();
    } else if (selectedOption === 'delete') {
        markers.splice(index, 1);
        updateMarkerList();
    }
    selectElem.selectedIndex = 0;
}


function convertTimeToTimecode(timeInSeconds, framesPerSecond) {
    var hours = Math.floor(timeInSeconds / 3600);
    timeInSeconds %= 3600;
    var minutes = Math.floor(timeInSeconds / 60);
    timeInSeconds %= 60;
    var seconds = Math.floor(timeInSeconds);
    var frames = Math.floor((timeInSeconds % 1) * framesPerSecond);
    return hours.toString().padStart(2, '0') + ":" 
        + minutes.toString().padStart(2, '0') + ":" 
        + seconds.toString().padStart(2, '0') + ":"
        + frames.toString().padStart(2, '0');
}

function forward(seconds) {
    videoElement.currentTime += seconds;
}

function rewind(seconds) {
    videoElement.currentTime = Math.max(0, videoElement.currentTime - seconds);
}

function exportMarkers() {
    var nameWithoutExtension = videoFile.replace(/\.[^/.]+$/, "");
    var text = '';
    markers.forEach(function(marker) {
        text += 'Sichtungsanmerkung\t' + marker.timecode + '\tTC\tred\t' + marker.description + '\t1\t\n';
    });

    var blob = new Blob([text], {type: "text/plain;charset=utf-8"});
    var a = document.createElement("a");
    document.body.appendChild(a);
    a.style = "display: none";
    url = window.URL.createObjectURL(blob);
    a.href = url;
    a.download = nameWithoutExtension + '_Anmerkungen_AvidMarker.txt';
    a.click();
    window.URL.revokeObjectURL(url);
}

function handleSaveOptions(selectElem) {
    var selectedOption = selectElem.value;
    if (selectedOption === 'save') {
        saveMarkers();
    } else if (selectedOption === 'load') {
        document.getElementById('loadMarkersFile').click();
    }
    selectElem.selectedIndex = 0;
}

function saveMarkers() {
    var date = new Date();
    var dateString = date.getFullYear() + '-' + ('0' + (date.getMonth()+1)).slice(-2) + '-' + ('0' + date.getDate()).slice(-2);
    var text = JSON.stringify(markers);
    var blob = new Blob([text], {type: "text/plain"});
    var a = document.createElement("a");
    document.body.appendChild(a);
    a.style = "display: none";
    var url = window.URL.createObjectURL(blob);
    a.href = url;
    a.download = videoFile.replace(/\.[^/.]+$/, "") + "_Anmerkungen_Speicherstand_" + dateString + ".txt";
    a.click();
    window.URL.revokeObjectURL(url);
}

function loadMarkers(event) {
    var file = event.target.files[0];
    var reader = new FileReader();
    reader.onload = function(e){
        var content = e.target.result;
        markers = JSON.parse(content);
        updateMarkerList();
    }
    reader.readAsText(file);
}

function handleExportOptions(selectElem) {
    var selectedOption = selectElem.value;

    // Fenster erscheint, um den Namen des Benutzers zu erfassen
    var userName = prompt("Bitte geben Sie Ihren Namen ein");
    if (!userName) {
        alert('Abbruch des Exports: Kein Name eingegeben.');
        selectElem.selectedIndex = 0;
        return;
    }

    if (selectedOption === 'markers') {
        exportMarkers(userName);
    } else if (selectedOption === 'table') {
        exportTable(userName);
    }
    selectElem.selectedIndex = 0;
}


function exportTable(userName) {
    var nameWithoutExtension = videoFile.replace(/\.[^/.]+$/, "");

    // Hinzufügen von "Sichtung durch: " und dem Namen des Benutzers unter dem Titel
    var text = 'Sichtungsname: ' + nameWithoutExtension + '\nSichtung durch: ' + userName + '\n\nNummer\tTimecode\tAnmerkung\n';

    markers.forEach(function(marker, index) {
        text += (index + 1) + '\t' + marker.timecode + '\t' + marker.description + '\n';
    });

    var blob = new Blob([text], {type: "text/plain;charset=utf-8"});
    var a = document.createElement("a");
    document.body.appendChild(a);
    a.style = "display: none";
    url = window.URL.createObjectURL(blob);
    a.href = url;
    a.download = nameWithoutExtension + '_Anmerkungen_Tabelle.txt';
    a.click();
    window.URL.revokeObjectURL(url);
}
function togglePlayPause() {
    var videoElement = document.getElementById("myVideo");
    if (videoElement.paused || videoElement.ended) {
        videoElement.play();
    } else {
        videoElement.pause();
    }
}

window.addEventListener('keydown', function(event) {
    // Überprüfen, ob das Transkript-Suchfeld den Fokus hat
    if (document.activeElement.id === 'transcriptSearch') {
        return; // Wenn ja, beenden Sie die Funktion frühzeitig
    }

    if (event.key === 'm' || event.key === 'M') {
        setMarker();
    } 
    else if (event.altKey && event.key === 's') {
        saveMarkers();
    } 
    else if (event.code === 'Space') {
        event.preventDefault();
        togglePlayPause();
    }
    else if (event.key === 'ArrowLeft') {
        event.preventDefault();
        if (event.altKey) {
            rewind(1/25); // 1 Frame zurück
        } else {
            rewind(5); // 5 Sekunden zurück
        }
    }
    else if (event.key === 'ArrowRight') {
        event.preventDefault();
        if (event.altKey) {
            forward(1/25); // 1 Frame vor
        } else {
            forward(5); // 5 Sekunden vor
        }
    }
});

</script>

<script>
 
fetch('Pfad-zum-Transkript.json')
  .then(response => response.json())
  .then(data => {
    const transcriptDiv = document.getElementById('transcript');
    data.forEach(item => {
        const p = document.createElement('p');
        p.textContent = item.text;
        p.style.cursor = 'pointer';
        p.onclick = () => {
           videoElement.currentTime = item.time;
        }
        transcriptDiv.appendChild(p);
    });
});
</script>

<style>
/* Normaler Modus */
body {
    background-color: white;
    color: black;
}

/* Dark Mode */
body.dark-mode {
    background-color: black;
    color: white;
}

body.dark-mode #shortcuts {
    color: black;
}

.videoControlBar {
    background-color: lightgray;
}

.videoControlBar.dark-mode {
    background-color: darkgray;
}

#transcript {
    top: 0;
    width: 90%;
    margin-left: 5%;
    margin-right: 5%;
}

#shortcuts {
    /* Andere Stile... */
    z-index: 1; /* Hintergrund */
}

#myVideo {
    position: relative; 
    /* Andere Stile... */
    z-index: 2; /* Vordergrund */
}

</style>

</body>
</html>